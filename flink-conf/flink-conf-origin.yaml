###############################################
# Flink Configuration for High Availability,
# Checkpointing, and RocksDB State Backend
###############################################

# ----------------- Cluster Setup -----------------
jobmanager.rpc.address: jobmanager
taskmanager.numberOfTaskSlots: 4
parallelism.default: 2

# ----------------- Web UI -----------------
rest.port: 8081

# ----------------- JobManager Memory -----------------
jobmanager.memory.process.size: 1g  # Fix for your error

# ----------------- State Backend (RocksDB) -----------------
state.backend: rocksdb
state.backend.rocksdb.localdir: /opt/flink/rocksdb
state.checkpoints.dir: s3://flink-data-1996/checkpoints
state.savepoints.dir: s3://flink-data-1996/savepoints
state.backend.incremental: true  # Enable incremental checkpointing

# ----------------- Checkpointing -----------------
execution.checkpointing.interval: 3min
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.unaligned: true
execution.checkpointing.timeout: 10m
execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION

# ----------------- High Availability (HA) -----------------
#high-availability: org.apache.flink.kubernetes.highavailability.KubernetesHaServicesFactory
#high-availability.storageDir: file:///opt/flink/ha
#high-availability.cluster-id: flink-cluster
#high-availability.kubernetes.namespace: flink-ha
#high-availability.jobmanager-port: 6123

# ----------------- TaskManager Memory -----------------
taskmanager.memory.process.size: 2g
taskmanager.memory.framework.heap.size: 128m
taskmanager.memory.framework.off-heap.size: 128m
taskmanager.memory.managed.fraction: 0.4

# ----------------- Advanced RocksDB Config -----------------
state.backend.rocksdb.thread.num: 4
state.backend.rocksdb.compaction.style: LEVEL
state.backend.rocksdb.compaction.level.max-size-amplification-percent: 200
state.backend.rocksdb.compaction.level.num-files-compaction-trigger: 10
state.backend.rocksdb.use-bloom-filter: true
state.backend.rocksdb.log.level: DEBUG_LEVEL

# ----------------- Metrics -----------------
metrics.reporter.prom.class: org.apache.flink.metrics.prometheus.PrometheusReporter
metrics.reporter.prom.port: 9249

# ----------------- JVM ARGS -----------------
env.java.opts: --add-opens java.base/java.util=ALL-UNNAMED --add-opens=java.base/java.time=ALL-UNNAMED

# Enable S3 filesystem plugin
s3.access-key:
s3.secret-key:
s3.endpoint: s3.amazonaws.com
s3.path.style.access: true